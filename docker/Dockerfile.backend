# ğŸ Use Python 3.9 slim image
FROM python:3.9-slim

# ğŸ·ï¸ Labels
LABEL maintainer="Your Name <your.email@example.com>"
LABEL version="7.0"
LABEL description="V2Ray Account Management Backend API"

# ğŸŒ Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# ğŸ“¦ Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libpq-dev \
    curl \
    netcat \
    && rm -rf /var/lib/apt/lists/*

# ğŸ“‚ Create and set working directory
WORKDIR /app

# ğŸ“‹ Copy requirements first for better caching
COPY requirements.txt .

# ğŸ“¥ Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# ğŸ“ Copy project files
COPY backend /app/backend

# ğŸ”„ Copy Alembic configuration and migrations
COPY backend/alembic.ini .
COPY backend/migrations /app/migrations

# ğŸ“ Create startup script
RUN echo '#!/bin/bash\n\
# Wait for database\n\
echo "Waiting for PostgreSQL..."\n\
while ! nc -z db 5432; do\n\
  sleep 1\n\
done\n\
echo "PostgreSQL started"\n\
\n\
# Wait for Redis\n\
echo "Waiting for Redis..."\n\
while ! nc -z redis 6379; do\n\
  sleep 1\n\
done\n\
echo "Redis started"\n\
\n\
# Run migrations\n\
echo "Running database migrations..."\n\
alembic upgrade head\n\
\n\
# Start API server\n\
echo "Starting FastAPI server..."\n\
uvicorn backend.app.main:app --host 0.0.0.0 --port 8000\n\
' > /app/start.sh

# Make startup script executable
RUN chmod +x /app/start.sh

# ğŸ‘¤ Create non-root user
RUN useradd -m apiuser && chown -R apiuser:apiuser /app
USER apiuser

# ğŸš€ Command to run the API
CMD ["/app/start.sh"]

# ğŸ” Health check
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/api/v1/health || exit 1

# ğŸ“¡ Expose port
EXPOSE 8000
